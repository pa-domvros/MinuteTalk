<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Version of 80 Topics (British English)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .topic-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            margin-bottom: 2rem;
            padding: 1.5rem;
        }
        .play-button {
            transition: all 0.2s ease-in-out;
        }
        .play-button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .modal {
            transition: opacity 0.25s ease;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-[#004AAD] mb-2">Listen to the Topics</h1>
            <p class="text-lg text-gray-600">Click the "Listen" button next to each topic to hear it read aloud in a British English accent.</p>
        </header>

        <div id="topics-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-8">
        </div>

        <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl flex items-center space-x-4">
                <svg class="animate-spin h-8 w-8 text-[#004AAD]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-lg font-medium">Generating Audio...</span>
            </div>
        </div>
        
        <div id="error-modal" class="modal hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                        <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    </div>
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Audio Generation Failed</h3>
                    <div class="mt-2 px-7 py-3">
                        <p id="error-message" class="text-sm text-gray-500">An error occurred while trying to generate the audio. Please try again.</p>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="close-modal-button" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                            OK
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const topics = {
            "Elementary": [
                "Your favourite colour.", "Your family.", "Your pet.", "Your favourite food.", "Your school.", "Your best friend.", "A toy you like.", "Your favourite animal.", "Your birthday.", "Your favourite fruit.", "A game you like to play.", "Your bedroom.", "The weather today.", "Your favourite holiday.", "What you did yesterday.", "Your favourite cartoon.", "Things you do in the morning.", "Your favourite piece of clothing.", "A place you like to go.", "What you want to be when you grow up."
            ],
            "Intermediate": [
                "Your favourite season and why.", "A recent movie you watched.", "Your favourite hobby.", "A place you have visited.", "Your daily routine.", "The best gift you have ever received.", "A food you could eat every day.", "Your favourite childhood memory.", "A time you felt very happy.", "Your dream vacation.", "Something you are good at.", "Your favourite type of music.", "The last book you read.", "A person you admire.", "If you could have any superpower, what would it be and why?", "Your plans for the upcoming weekend.", "Something that makes you laugh.", "A challenge you have overcome.", "Your favourite subject in school and why.", "A family tradition you enjoy."
            ],
            "Upper-Intermediate": [
                "A book or movie that changed your perspective.", "The pros and cons of social media.", "A historical event that fascinates you.", "What does it mean to be a good friend?", "The most important lesson you've learned in life so far.", "A time you learned something the hard way.", "If you could give one piece of advice to a younger person, what would it be?", "The importance of learning a foreign language.", "A technology you believe has changed the world for the better (or worse).", "Your definition of success.", "How do you deal with stress?", "A place you would love to live in for a year.", "The role of sports in society.", "A song that brings back strong memories.", "The qualities of a great leader.", "An environmental issue you are concerned about.", "The best and worst parts of your daily routine.", "How has technology changed education?", "A personal goal you are currently working towards.", "The difference between being a tourist and a traveller."
            ],
            "Advanced": [
                "Discuss the ethical implications of artificial intelligence.", "\"Travel is the only thing you buy that makes you richer.\" Do you agree or disagree?", "The role of government in ensuring the well-being of its citizens.", "Is it more important to be liked or to be respected?", "The impact of globalization on local cultures.", "Can censorship ever be justified?", "The relationship between art and society.", "What is the most significant challenge facing humanity in the 21st century?", "\"The unexamined life is not worth living.\" (Socrates) What does this mean to you?", "Discuss the concept of \"privilege\" and its effect on an individual's life.", "Should higher education be free for everyone?", "The psychological effects of living in a hyper-connected world.", "What is the meaning of a \"fulfilling life\"?", "The balance between individual freedom and collective responsibility.", "How do you think work will change in the next 50 years?", "Is space exploration a worthwhile investment?", "The morality of genetic engineering.", "Discuss the philosophical concept of happiness.", "The influence of media on political discourse.", "If you could change one thing about your country's political or social system, what would it be and why?"
            ]
        };

        const topicsContainer = document.getElementById('topics-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const errorModal = document.getElementById('error-modal');
        const closeModalButton = document.getElementById('close-modal-button');
        const errorMessageElement = document.getElementById('error-message');

        closeModalButton.onclick = () => errorModal.classList.add('hidden');

        function showErrorModal(message) {
            errorMessageElement.textContent = message;
            errorModal.classList.remove('hidden');
        }

        Object.keys(topics).forEach(level => {
            const card = document.createElement('div');
            card.className = 'topic-card';

            const title = document.createElement('h2');
            title.className = 'text-2xl font-bold text-[#004AAD] mb-4 border-b-2 border-[#0079C2] pb-2';
            title.textContent = level;
            card.appendChild(title);

            const list = document.createElement('ul');
            list.className = 'space-y-3';
            topics[level].forEach(topic => {
                const listItem = document.createElement('li');
                listItem.className = 'flex items-center justify-between';

                const topicText = document.createElement('span');
                topicText.className = 'flex-1 mr-4';
                topicText.textContent = topic;
                listItem.appendChild(topicText);

                const button = document.createElement('button');
                button.className = 'play-button bg-[#0079C2] hover:bg-[#00AEEF] text-white font-bold py-2 px-4 rounded-full flex items-center';
                button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg> Listen`;
                button.onclick = () => playTopic(topic, button);
                listItem.appendChild(button);

                list.appendChild(listItem);
            });

            card.appendChild(list);
            topicsContainer.appendChild(card);
        });
        
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bitsPerSample = 16;
            const blockAlign = (numChannels * bitsPerSample) / 8;
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcmData.length * pcmData.BYTES_PER_ELEMENT;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }
            
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);

            const pcm16 = new Int16Array(pcmData.buffer);
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(44 + i * 2, pcm16[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        async function playTopic(text, button) {
            loadingOverlay.classList.remove('hidden');
            button.disabled = true;

            try {
                const apiKey = ""; // The API key is handled by the Canvas environment
                const googleApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                
                // Use a public CORS proxy to bypass browser security restrictions
                const proxyUrl = 'https://thingproxy.freeboard.io/fetch/';
                const proxiedUrl = proxyUrl + googleApiUrl;

                const payload = {
                    contents: [{
                        parts: [{ text: `Say in a standard British English accent: ${text}` }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };
                
                const response = await fetch(proxiedUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch. Status: ${response.status}`);
                }

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    const audio = new Audio(audioUrl);
                    audio.play();

                    audio.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                    };

                } else {
                    console.error("Audio data not found in API response", result);
                    showErrorModal("Sorry, the audio data could not be retrieved from the service.");
                }

            } catch (error) {
                console.error('Error fetching TTS via proxy:', error);
                showErrorModal(error.message || "An unexpected error occurred. Please check your connection and try again.");
            } finally {
                loadingOverlay.classList.add('hidden');
                button.disabled = false;
            }
        }
    </script>
</body>
</html>
